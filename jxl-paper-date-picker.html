<link rel="import" href="jxl-paper-calendar.html">
<link rel="import" href="../paper-material/paper-material.html">
<link rel="import" href="../paper-icon-button/paper-icon-button.html">
<link rel="import" href="../iron-icons/iron-icons.html">
<link rel="import" href="../iron-icons/hardware-icons.html">
<link rel="import" href="../neon-animation/neon-animation-runner-behavior.html">
<link rel="import" href="../neon-animation/animations/fade-out-animation.html">
<link rel="import" href="../neon-animation/animations/fade-in-animation.html">
<link rel="import" href="../neon-animation/animations/slide-left-animation.html">
<link rel="import" href="../neon-animation/animations/slide-from-right-animation.html">


<dom-module id="jxl-paper-date-picker">

	<style>

	:host {
		display: block;
		width: 330px;
		height: 400px;
		text-align: center;
	}

	.yearHeading
	{
		opacity: 0.84;
		font-size: 1em;
		color: #FFFFFF;
		padding: 2px 8px 2px 8px;
		text-align: left;
	}

	.dateHeading
	{
		font-size: 2.2em;
		color: #FFFFFF;
		padding: 2px 8px 2px 8px;
		text-align: left;
	}

	.headerBackground
	{
		background-color: #2196F3;
		border-top-left-radius:2px;
		border-top-right-radius:2px;
	}

	.wrapperPadding
	{
		padding: 12px;
	}

	.monthHeader
	{
		text-align: center;
	}

	.monthStepper
	{
		height: 44px;
		line-height: 44px;
	}

	.weekdayItem.weekdayItemButton
	{
		padding: 0px;
	}
	.weekdayItem.weekdayItemButton.previousButton
	{
		margin-left: 0px;
	}
	.weekdayItem.weekdayItemButton.nextButton
	{
		margin-right: 0px;
	}

	.weekdayItem
	{
		font-size: 0.9em;
		min-width: 40px;
		max-width: 40px;
		margin: 1px 2px;
		border-radius: 50%;
		width: 40px;
		height: 40px;
		line-height: 40px;
		opacity: 0.54;
	}

	.calendarBackground
	{
		background-color: #FFFFFF;
		margin-left: 10px;
		margin-right: 10px;
	}

	.marginLeft5
	{
		margin-left: 5px;
	}

	.marginRight5
	{
		margin-right: 5px;
	}

	jxl-paper-calendar {
		display: inline-block;
		position: absolute;
		/*visibility: hidden;*/
		opacity: 0px;
		top: 0px;
		left: 0px;
	}

	</style>

	<template>

		<paper-material elevation="1">

			<div class="layout vertical headerBackground">
				<div class="wrapperPadding layout vertical">
					<div class="yearHeading">{{getYear(currentDate)}}</div>
					<div class="dateHeading">{{getDateHeader(currentDate)}}</div>
				</div>
			</div>
			<div class="layout vertical calendarBackground">
				<div class="layout horizontal center-center monthStepper">
					<paper-icon-button class="marginLeft5 weekdayItem weekdayItemButton previousButton" icon="hardware:keyboard-arrow-left" on-click="onPreviousMonth"></paper-icon-button>
					<div class="flex monthHeader" >{{getMonth(currentDate)}}</div>
					<paper-icon-button class="marginRight5 weekdayItem weekdayItemButton nextButton" icon="hardware:keyboard-arrow-right" on-click="onNextMonth"></paper-icon-button>
				</div>
			</div>

			<div style="position: relative; width: 330px; height: 306px; overflow: hidden;">
				<jxl-paper-calendar id="calendar1" 
					current-date="{{getCurrentDate(currentDate, 'calendar1')}}" 
					selected-date="{{selectedDate}}"></jxl-paper-calendar>
				<jxl-paper-calendar id="calendar2" 
					current-date="{{getCurrentDate(currentDate, 'calendar2')}}" 
					selected-date="{{selectedDate}}"></jxl-paper-calendar>
			</div>

			<content></content>

		</paper-material>

	</template>

	<script>
	Polymer({

		is: "jxl-paper-date-picker",

		behaviors: [
			Polymer.NeonAnimationRunnerBehavior
		],

		properties: {

			currentDate: {
				type: Date,
				value: function(){return moment()},
				observer: "_currentDateChanged",
				notify: true
			},

			selectedDate: {
				type: Date,
				value: function(){return null;},
				observer: "_selectedDateChanged",
				notify: true
			},

			animationConfig: {
				type: Object,
				value: function()
				{
					return {
						'nextMonthOut': [
							{
								name: 'fade-out-animation',
								node: this.$.calendar1,
								timing: {duration: 500}
							},

							{
								name: 'slide-left-animation',
								node: this.$.calendar1,
								timing: {duration: 500}
							}
						],

						'nextMonthIn': [
							{
								name: 'fade-in-animation',
								node: this.$.calendar2,
								timing: {duration: 500}
							},

							{
								name: 'slide-from-right-animation',
								node: this.$.calendar2,
								timing: {duration: 500}
							}
						]
					}
				}
			},
		},

		listeners: {
			'neon-animation-finish': '_fadeOutComplete'
		},

		calendarIndex: 1,
		otherCalendarIndex: 2,
		moving: false,
		movingCount: 0,
		lastSelected: null,
		direction: null,

		attached: function()
		{
			this.$['calendar' + this.calendarIndex].style.opacity = 1; 
		},

		_currentDateChanged: function(newValue, oldValue)
		{

		},

		_selectedDateChanged: function(newValue, oldValue)
		{

		},

		getYear: function(date)
		{
			return date.year();
		},

		getDateHeader: function(date)
		{
			return date.format("ddd, MMM D");
		},

		getMonth: function(date)
		{
			return date.format("MMMM YYYY")
		},

		getCurrentDate: function(date, name)
		{
			if(this.moving)
			{
				var targetName;
				if(this.direction === 'left')
				{
					targetName = 'calendar' + this.calendarIndex;
				}
				else
				{
					targetName = 'calendar' + this.otherCalendarIndex;
				}

				if(name === targetName)
				{
					return this.lastCurrentDate;
				}
			}
			return date;
		},

		onPreviousMonth: function()
		{
			this.currentDate = this.currentDate.clone().subtract(1, 'months');
		},

		onNextMonth: function()
		{
			if(this.moving)
			{
				return;
			}
			console.log("started...");
			this.moving = true;
			this.movingCount = 2;
			this.direction = "left";
			this.lastCurrentDate =  this.currentDate.clone();
			var me = this;
			_.forEach(me.animationConfig['nextMonthOut'], function(anime)
			{
				anime.node = me.$["calendar" + me.calendarIndex];
			});
			_.forEach(me.animationConfig['nextMonthIn'], function(anime)
			{
				anime.node = me.$["calendar" + me.otherCalendarIndex];
			});
			var obj = me.$["calendar" + me.calendarIndex];
			this.toggleAttribute('selected-date', false, obj);
			this.currentDate = this.currentDate.clone().add(1, 'months');
			me.playAnimation('nextMonthOut', {index: me.calendarIndex, type: 'nextMonthOut'});
			me.playAnimation('nextMonthIn', {index: me.otherCalendarIndex, type: 'nextMonthIn'});
		},

		_fadeOutComplete: function(event, cookie)
		{
			// // console.log("jxl-paper-date-picker::_fadeOutComplete, args:", arguments);
			// if(cookie.type === 'nextMonthOut')
			// {
			// 	this.$['calendar' + this.calendarIndex].style.opacity = 1;
			// 	if(this.calendarIndex === 1)
			// 	{
			// 		this.calendarIndex = 2;
			// 	}
			// 	else
			// 	{
			// 		this.calendarIndex = 1;
			// 	}
			// }
			// else if(cookie.type === 'nextMonthIn')
			// {
			// 	this.$['calendar' + this.otherCalendarIndex].style.opacity = 1;
			// 	if(this.otherCalendarIndex === 1)
			// 	{
			// 		this.otherCalendarIndex = 2;
			// 	}
			// 	else
			// 	{
			// 		this.otherCalendarIndex = 1;
			// 	}
			// }
			
			this.movingCount--;
			if(this.movingCount <= 0)
			{
				this.moving = false;
			}
		}

	});

	</script>

</dom-module>